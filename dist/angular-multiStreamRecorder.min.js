angular.module("ByGiro.multiStreamRecorder",[]).directive("multiStreamRecorder",["$window","$parse","$q",function(e,t,o){return{restrict:"AE",scope:{dataVal:"=?ngModel"},template:'<video ng-if="opts.type != \'audio\'" class="stream-recorder video-js vjs-default-skin {{opts.class}}" style="background-color: #9FD6BA;"></video><audio ng-if="opts.type == \'audio\'" class="stream-recorder video-js vjs-default-skin {{opts.class}}" style="background-color: #9FD6BA;"></audio><br><button ng-click=upload(); ng-show=btnVisible class="btn btn-default">{{opts.text.uploadBtn}}</button><div ng-show=showUploadStatus class=upload-status><span style="float:left; font-style: italic; font-size:70%;">partial time left: {{timeLeft}} - speed: {{speed}}</span><br><div class=progress><div class="progress-bar progress-bar-primary progress-bar-striped active" role=progressbar aria-valuenow={{completed}} aria-valuemin=0 aria-valuemax=100 style=width:{{completed}}%>{{completed}}%</div></div><span style="float:left; font-style: italic; font-size:70%;">total time left: {{totalTimeLeft}}</span><br><div class=progress><div class="progress-bar progress-bar-success active" role=progressbar aria-valuenow={{totalCompleted}} aria-valuemin=0 aria-valuemax=100 style=width:{{totalCompleted}}%>{{totalCompleted}}%</div></div></div><div ng-show=uploadError class="label label-danger">{{opts.text.uploadError}}</div><div ng-show=uploaded class="label label-success">{{opts.text.uploaded}}</div>',link:function(e,t,o){function a(e,t,o){t=t||"",o=o||512;for(var a=atob(e),r=[],s=0;s<a.length;s+=o){for(var n=a.slice(s,s+o),l=new Array(n.length),d=0;d<n.length;d++)l[d]=n.charCodeAt(d);var i=new Uint8Array(l);r.push(i)}var p=new Blob(r,{type:t});return p}function r(){var t=e.$root.$$phase;"$apply"!=t&&"$digest"!=t&&e.$apply()}var s,n,l="undefined"!=typeof jQuery?jQuery:angular.element,d={},i={text:{uploadBtn:"Upload",days:"Days",hours:"Hours",minutes:"Mins",seconds:"Sec",uploadError:"Error on upload, please try again",uploaded:"Uploaded"},type:"stream","class":"",video:{controls:!0,width:320,height:240,plugins:{record:{audio:!0,video:!0,maxLength:10}}},splitAt:1e3,uploadUrl:"",uploadBtn:!1,recordOnce:!1,maxLength:10,onDeviceError:!1,onStartRecord:!1,onFinishRecord:!1,onUploadError:!1,onUploadCompleted:!1},p=o.msrOptions&&e.$parent[o.msrOptions];switch(e.btnVisible=!1,e.uploadStatus=!1,e.uploaded=!1,e.uploadError=!1,e.uploadBtnTemp=!1,p&&(d=e.$parent[o.msrOptions]),d.type=(d.type||i.type).toLowerCase(),d.type){case"video":i.video.plugins.record.audio=!1;break;case"audio":i.video.plugins.wavesurfer={src:"live",waveColor:"black",progressColor:"#2E732D",cursorWidth:1,msDisplayMax:20,hideScrollbar:!0},i.video.plugins.record.video=!1;break;case"gif":i.video.controlBar={volumeMenuButton:!1,fullscreenToggle:!1},i.video.plugins.record={animation:!0,animationQuality:20,animationFrameRate:200,maxLength:5};break;case"image":i.video.controlBar={volumeMenuButton:!1,fullscreenToggle:!1},i.video.plugins.record={image:!0};break;case"stream":}p&&(e.opts=l.extend({},i,d)),d.text&&(e.opts.text=l.extend({},i.text,d.text)),e.opts.video.plugins.record.maxLength=e.opts.maxLength;var u={};e.upload=function(){function t(e){var t=["Bytes","KB","MB","GB","TB"];if(0==e)return"0 Byte";var o=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,o),2)+" "+t[o]}function o(t){var o=new Date(t),a=o.getUTCDate()-1,r=o.getUTCHours(),s=o.getUTCMinutes(),n=o.getUTCSeconds(),l=[];return a&&l.push(a+" "+e.opts.text.days),r&&l.push(r+" "+e.opts.text.hours),s&&l.push(s+" "+e.opts.text.minutes),l.push(n+" "+e.opts.text.seconds),l.join(", ")}if(e.opts.uploadUrl&&""!=e.opts.uploadUrl&&e.dataVal&&""!=e.dataVal){var s=e.dataVal;"image"==e.opts.type&&(s=s.split("base64,"),s=a(s[1]));var n=e.opts.splitAt||s.size;fileReader=new FileReader,fileReader.onload=function(a){function s(a){return new Promise(function(s,n){console.log(a.index,a.data.size);var l=Object.keys(u).length,i=new FormData;i.append("index",a.index),i.append("data",a.data),e.btnVisible=!1,r();var f=new XMLHttpRequest;f.onreadystatechange=function(){4==f.readyState&&(200==f.status?(u[a.index]="ok",l>=c&&("function"==typeof e.opts.onUploadCompleted&&e.opts.onUploadCompleted(),e.showUploadStatus=!1,e.uploaded=!0,r()),s(f.response)):(e.showUploadStatus=!1,e.btnVisible=!0,e.uploadError=!0,r(),"function"==typeof e.opts.onUploadError&&e.opts.onUploadError(f),n(f)))};var v,m,g,h=(new Date).getTime(),y="0 kb",b="",w=0,x=0;e.speed=y+"/sec",e.timeLeft=b,e.completed=w,e.totalCompleted=w,f.upload.onprogress=function(a){c>1&&(x=l*d),v=(new Date).getTime(),g=v-h,w=parseInt(100*a.loaded/a.total),totalCompleted=parseInt(100*(a.loaded+x)/p),m=1e3*a.loaded/g,b=o(parseInt((a.total-a.loaded)/m*1e3)),totalTimeLeft=o(parseInt((p-(a.loaded+x))/m*1e3)),y=t(m),e.speed=y+"/sec",e.timeLeft=b,e.totalTimeLeft=totalTimeLeft,e.completed=w,e.totalCompleted=totalCompleted,r()},f.onerror=function(){n(Error("Error fetching data."))},f.open("POST",e.opts.uploadUrl),f.send(i)})}var l=new Uint8Array(this.result),d=1e3*n,i=0,p=l.length,c=parseInt(l.length/d);e.showUploadStatus=!0,e.uploadError=!1;for(var f=[],i=0,v=0;v<l.length;v+=d)if(i++,"undefined"==typeof u[i]){var m=new Blob([l.subarray(v,v+d)]);f.push({data:m,index:i})}f.reduce(function(e,t){return e.then(function(){return s(t)})},Promise.resolve())},fileReader.readAsArrayBuffer(s)}},setTimeout(function(){s=t[0].querySelectorAll(".stream-recorder")[0],n=videojs(s,e.opts.video),n.on("deviceError",function(){"function"==typeof e.opts.onDeviceError&&e.opts.onDeviceError.apply(this)}),n.on("startRecord",function(){e.opts.uploadBtn&&(u={},e.btnVisible=!1,e.uploaded=!1,e.uploadBtnTemp=!1,e.uploadError=!1,r()),"function"==typeof e.opts.onStartRecord&&e.opts.onStartRecord.apply(this)}),n.on("finishRecord",function(){"function"==typeof e.opts.onFinishRecord&&e.opts.onFinishRecord.apply(this),e.dataVal=this.recordedData,this.recordedData&&(e.opts.uploadBtn?e.btnVisible=!0:e.upload()),e.opts.recordOnce&&this.recordToggle.hide(),r()})},50)}}}]);