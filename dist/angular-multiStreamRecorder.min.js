angular.module("ByGiro.multiStreamRecorder",[]).directive("multiStreamRecorder",["$window","$parse",function(e,t){return{restrict:"AE",scope:{dataVal:"=?ngModel"},template:'<video ng-if="opts.streamType != \'audio\'" class="stream-recorder video-js vjs-default-skin {{opts.class}}" style="background-color: #9FD6BA;"></video><audio ng-if="opts.streamType == \'audio\'" class="stream-recorder video-js vjs-default-skin {{opts.class}}" style="background-color: #9FD6BA;"></audio><br><button ng-click=upload(); ng-show=btnVisible class="btn btn-default">{{opts.text.uploadBtn}}</button><div ng-show=showUploadStatus class=upload-status><span style="float:left; font-style: italic; font-size:70%;">partial time left: {{timeLeft}} - speed: {{speed}}</span><br><div class=progress><div class="progress-bar progress-bar-primary progress-bar-striped active" role=progressbar aria-valuenow={{completed}} aria-valuemin=0 aria-valuemax=100 style=width:{{completed}}%>{{completed}}%</div></div><span style="float:left; font-style: italic; font-size:70%;">total time left: {{totalTimeLeft}}</span><br><div class=progress><div class="progress-bar progress-bar-success active" role=progressbar aria-valuenow={{totalCompleted}} aria-valuemin=0 aria-valuemax=100 style=width:{{totalCompleted}}%>{{totalCompleted}}%</div></div></div><div ng-show=uploadError class="label label-danger">{{opts.text.uploadError}}</div><div ng-show=uploaded class="label label-success">{{opts.text.uploaded}}</div>',link:function(e,t,o){function a(){var e,t=navigator.userAgent,o=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(o[1])?(e=/\brv[ :]+(\d+)/g.exec(t)||[],{name:"IE",version:e[1]||""}):"Chrome"===o[1]&&(e=t.match(/\bOPR\/(\d+)/),null!=e)?{name:"Opera",version:e[1]}:(o=o[2]?[o[1],o[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/(\d+)/i))&&o.splice(1,1,e[1]),{name:o[0],version:o[1]})}function r(e,t){var o=new FileReader;o.onload=function(){"function"==typeof t&&t(o.result)},o.readAsDataURL(e)}function s(e,t){t=t||512,e=e.replace(/data:/i,"").split(";base64,");var o=e[0];e=e[1];for(var a=atob(e),r=[],s=0;s<a.length;s+=t){for(var n=a.slice(s,s+t),i=new Array(n.length),l=0;l<n.length;l++)i[l]=n.charCodeAt(l);var d=new Uint8Array(i);r.push(d)}var p=new Blob(r,{type:o});return p}function n(){var t=e.$root.$$phase;"$apply"!=t&&"$digest"!=t&&e.$apply()}var i,l,d="undefined"!=typeof jQuery?jQuery:angular.element,p="",u=!0,c={},m={},v={text:{uploadBtn:"Upload",days:"Days",hours:"Hours",minutes:"Mins",seconds:"Sec",uploadError:"Error on upload, please try again",uploaded:"Uploaded",notSupported:"Browser not supported"},streamType:"stream","class":"",video:{controls:!0,width:320,height:240,plugins:{record:{audio:!0,video:!0,maxLength:10}}},setModel:!0,base64Result:!1,splitAt:1e3,uploadUrl:"",uploadBtn:!1,recordOnce:!1,maxLength:10,onDeviceError:!1,onStartRecord:!1,onFinishRecord:!1,onUploadError:!1,onUploadCompleted:!1},f=o.msrOptions&&e.$parent[o.msrOptions];switch(e.btnVisible=!1,e.uploadStatus=!1,e.uploaded=!1,e.uploadError=!1,e.uploadBtnTemp=!1,f&&(m=e.$parent[o.msrOptions]),m.streamType=(m.streamType||v.streamType).toLowerCase(),m.streamType){case"video":v.video.plugins.record.audio=!1;break;case"audio":v.video.plugins.wavesurfer={src:"live",waveColor:"black",progressColor:"#2E732D",cursorWidth:1,msDisplayMax:20,hideScrollbar:!0},v.video.plugins.record.video=!1;break;case"gif":v.video.controlBar={volumeMenuButton:!1,fullscreenToggle:!1},v.video.plugins.record={animation:!0,animationQuality:20,animationFrameRate:200,maxLength:5};break;case"image":v.video.controlBar={volumeMenuButton:!1,fullscreenToggle:!1},v.video.plugins.record={image:!0};break;case"stream":}f&&(e.opts=d.extend({},v,m)),m.text&&(e.opts.text=d.extend({},v.text,m.text)),e.opts.video.plugins.record.maxLength=e.opts.maxLength,c={stream:{Chrome:!0},video:{},audio:{},gif:{},image:{}};var g={};e.upload=function(){function t(e){var t=["Bytes","KB","MB","GB","TB"];if(0==e)return"0 Byte";var o=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,o),2)+" "+t[o]}function o(t){var o=new Date(t),a=o.getUTCDate()-1,r=o.getUTCHours(),s=o.getUTCMinutes(),n=o.getUTCSeconds(),i=[];return a&&i.push(a+" "+e.opts.text.days),r&&i.push(r+" "+e.opts.text.hours),s&&i.push(s+" "+e.opts.text.minutes),i.push(n+" "+e.opts.text.seconds),i.join(", ")}if(e.opts.uploadUrl&&""!=e.opts.uploadUrl&&p&&""!=p){var a=p;e.opts.base64Result&&(a=s(a));var r=e.opts.splitAt||a.size;fileReader=new FileReader,fileReader.onload=function(a){function s(a){return new Promise(function(r,s){var i=Object.keys(g).length,d=new FormData;d.append("index",a.index),d.append("data",a.data),e.btnVisible=!1,n();var c=new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&(200==c.status?(g[a.index]="ok",i>=u&&("function"==typeof e.opts.onUploadCompleted&&e.opts.onUploadCompleted(),e.showUploadStatus=!1,e.uploaded=!0,n()),r(c.response)):(e.showUploadStatus=!1,e.btnVisible=!0,e.uploadError=!0,n(),"function"==typeof e.opts.onUploadError&&e.opts.onUploadError(c),s(c)))};var m,v,f,h=(new Date).getTime(),y="0 kb",b="",w=0,x=0;e.speed=y+"/sec",e.timeLeft=b,e.completed=w,e.totalCompleted=w,c.upload.onprogress=function(a){u>1&&(x=i*l),m=(new Date).getTime(),f=m-h,w=parseInt(100*a.loaded/a.total),totalCompleted=parseInt(100*(a.loaded+x)/p),v=1e3*a.loaded/f,b=o(parseInt((a.total-a.loaded)/v*1e3)),totalTimeLeft=o(parseInt((p-(a.loaded+x))/v*1e3)),y=t(v),e.speed=y+"/sec",e.timeLeft=b,e.totalTimeLeft=totalTimeLeft,e.completed=w,e.totalCompleted=totalCompleted,n()},c.onerror=function(){s(Error("Error fetching data."))},c.open("POST",e.opts.uploadUrl),c.send(d)})}var i=new Uint8Array(this.result),l=1e3*r,d=0,p=i.length,u=parseInt(i.length/l);e.showUploadStatus=!0,e.uploadError=!1;for(var c=[],d=0,m=0;m<i.length;m+=l)if(d++,"undefined"==typeof g[d]){var v=new Blob([i.subarray(m,m+l)]);c.push({data:v,index:d})}c.reduce(function(e,t){return e.then(function(){return s(t)})},Promise.resolve())},fileReader.readAsArrayBuffer(a)}};var h,y=a(),b=c[e.opts.type];b&&b[y.name]&&(h=b[y.name],(h===!0||parseInt(y.version)<h)&&(u=!1)),setTimeout(function(){return u?(i=t[0].querySelectorAll(".stream-recorder")[0],l=videojs(i,e.opts.video),l.on("deviceError",function(){"function"==typeof e.opts.onDeviceError&&e.opts.onDeviceError.apply(this)}),l.on("startRecord",function(){e.opts.uploadBtn&&(g={},e.btnVisible=!1,e.uploaded=!1,e.uploadBtnTemp=!1,e.uploadError=!1,n()),"function"==typeof e.opts.onStartRecord&&e.opts.onStartRecord.apply(this)}),void l.on("finishRecord",function(){"function"==typeof e.opts.onFinishRecord&&e.opts.onFinishRecord.apply(this);var t=function(t){p=t,e.opts.setModel&&(e.dataVal=t),t&&(e.opts.uploadBtn?e.btnVisible=!0:e.upload()),e.opts.recordOnce&&l.recordToggle.hide(),n()},o=this.recordedData;e.opts.base64Result?"image"==e.opts.streamType?t(o):r(o,t):("image"==e.opts.streamType&&(o=s(o)),t(o))})):void t.html('<p style="font-size: 120%; color: red; text-align: center; font-style: italic;">'+e.opts.text.notSupported+"</p>")},50)}}}]);